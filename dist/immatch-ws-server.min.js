/*! imMatch v1.0.1pre Websocket Server https://bitbucket.org/kf99916/immatch | MIT license */!function(a,b){b(a)}("undefined"!=typeof window?window:this,function(a){"use strict";!function(){var a="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");Math.uuid=function(b,c){var d=a,e=[],f;if(c=c||d.length,b)for(f=0;b>f;f++)e[f]=d[0|Math.random()*c];else{var g;for(e[8]=e[13]=e[18]=e[23]="-",e[14]="4",f=0;36>f;f++)e[f]||(g=0|16*Math.random(),e[f]=d[19==f?3&g|8:g])}return e.join("")},Math.uuidFast=function(){for(var b=a,c=new Array(36),d=0,e,f=0;36>f;f++)8==f||13==f||18==f||23==f?c[f]="-":14==f?c[f]="4":(2>=d&&(d=33554432+16777216*Math.random()|0),e=15&d,d>>=4,c[f]=b[19==f?3&e|8:e]);return c.join("")},Math.uuidCompact=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})}}(),a=require("jsdom").jsdom().parentWindow;var b=require("jquery/dist/jquery")(a),c=require("ws");function d(){return!0}function e(){return!1}function f(a){return"["+a.toUpperCase()+"] "+Date()+" :"}Date.now=Date.now||function o(){return(new Date).getTime()};var g=a.document,h=[],i=h.slice,j=h.indexOf,k=h.push,l=h.unshift,m=JSON.stringify,n=b({});return n.AffineTransform=function(a,b,c,d,e,f){return this instanceof n.AffineTransform?void this.setTransform(a,b,c,d,e,f):new n.AffineTransform(a,b,c,d,e,f)},n.AffineTransform.getScaleInstance=function(a){return(new n.AffineTransform).setToScale(a)},n.AffineTransform.getTranslationInstance=function(a){return(new n.AffineTransform).setToTranslation(a)},n.AffineTransform.getShearInstance=function(a){return(new n.AffineTransform).setToShear(a)},n.AffineTransform.getRotateInstance=function(a,b){return(new n.AffineTransform).setToRotation(a,b)},n.AffineTransform.prototype={setTransform:function(a,c,d,e,f,g){return b.isNumeric(a)&&b.isNumeric(d)&&b.isNumeric(f)&&b.isNumeric(c)&&b.isNumeric(e)&&b.isNumeric(g)?(this.m00=a,this.m01=d,this.m02=f,this.m10=c,this.m11=e,this.m12=g,this):(this.m00=this.m11=1,this.m01=this.m02=this.m10=this.m12=0,this)},clone:function(){return new n.AffineTransform(this.m00,this.m10,this.m01,this.m11,this.m02,this.m12)},scale:function(a){return this.concatenate(n.AffineTransform.getScaleInstance(a))},preScale:function(a){return this.preConcatenate(n.AffineTransform.getScaleInstance(a))},translate:function(a){return this.concatenate(n.AffineTransform.getTranslationInstance(a))},preTranslate:function(a){return this.preConcatenate(n.AffineTransform.getTranslationInstance(a))},rotate:function(a,b){return this.concatenate(n.AffineTransform.getRotateInstance(a,b))},preRotate:function(a,b){return this.preConcatenate(n.AffineTransform.getRotateInstance(a,b))},shear:function(a){return this.concatenate(n.AffineTransform.getShearInstance(a))},preShear:function(a){return this.preConcatenate(n.AffineTransform.getShearInstance(a))},concatenate:function(a){if(!(!n.isEmpty(a)&&b.isNumeric(a.m00)&&b.isNumeric(a.m01)&&b.isNumeric(a.m02)&&b.isNumeric(a.m10)&&b.isNumeric(a.m11)&&b.isNumeric(a.m12)))return this;var c=this.m00,d=this.m01;return this.m00=a.m00*c+a.m10*d,this.m01=a.m01*c+a.m11*d,this.m02+=a.m02*c+a.m12*d,c=this.m10,d=this.m11,this.m10=a.m00*c+a.m10*d,this.m11=a.m01*c+a.m11*d,this.m12+=a.m02*c+a.m12*d,this},preConcatenate:function(a){if(!(!n.isEmpty(a)&&b.isNumeric(a.m00)&&b.isNumeric(a.m01)&&b.isNumeric(a.m02)&&b.isNumeric(a.m10)&&b.isNumeric(a.m11)&&b.isNumeric(a.m12)))return this;var c=this.m00,d=this.m10;return this.m00=a.m00*c+a.m01*d,this.m10=a.m10*c+a.m11*d,c=this.m01,d=this.m11,this.m01=a.m00*c+a.m01*d,this.m11=a.m10*c+a.m11*d,c=this.m02,d=this.m12,this.m02=a.m00*c+a.m01*d+a.m02,this.m12=a.m10*c+a.m11*d+a.m12,this},transform:function(a){return n.is2DVector(a)?{x:a.x*this.m00+a.y*this.m01+this.m02,y:a.x*this.m10+a.y*this.m11+this.m12}:{x:0,y:0}},getDeterminant:function(){return this.m00*this.m11-this.m01*this.m10},isInvertible:function(){var a=this.getDeterminant();return b.isNumeric(a)&&b.isNumeric(this.m02)&&b.isNumeric(this.m12)&&0!==a},inverse:function(){if(!this.isInvertible)return this;var a=this.getDeterminant(),b=this.m00,c=this.m10,d=this.m01,e=this.m11,f=this.m02,g=this.m12;return this.m00=e/a,this.m10=-c/a,this.m01=-d/a,this.m11=b/a,this.m02=(d*g-e*f)/a,this.m12=(c*f-b*g)/a,this},createInverse:function(){return this.isInvertible?this.clone().inverse():this},setToScale:function(a){return b.isEmptyObject(a)&&(a={x:1,y:1}),this.setTransform(a.x,0,0,a.y,0,0)},setToTranslation:function(a){return b.isEmptyObject(a)&&(a={x:0,y:0}),this.setTransform(1,0,0,1,a.x,a.y)},setToShear:function(a){return b.isEmptyObject(a)&&(a={x:0,y:0}),this.setTransform(1,a.y,a.x,1,0,0)},setToRotation:function(a,c){b.isEmptyObject(c)&&(c={x:0,y:0}),a=b.isNumeric(a)?a:0;var d=Math.cos(a),e=Math.sin(a);return this.setTransform(d,e,-e,d,c.x-c.x*d+c.y*e,c.y-c.x*e-c.y*d)},toJSON:function(){return[this.m00,this.m10,this.m01,this.m11,this.m02,this.m12]},print:function(){a.console.log("[ "+this.m00+" "+this.m01+" "+this.m02+" ]"),a.console.log("[ "+this.m10+" "+this.m11+" "+this.m12+" ]"),a.console.log("[ 0 0 1 ]"),a.console.log()}},n.Cache=function(){return this instanceof n.Cache?void 0:new n.Cache},n.Cache.prototype={queue:function(a,c,d){return n.isEmpty(a)||n.isEmpty(c)?this:(this[a]=this[a]||[],k.call(this[a],c),b.isFunction(d)?(this[a].sort(d),this):this)},dequeue:function(a){var c={};return n.isEmpty(a)||b.isEmptyObject(this[a])?c:(c=this[a].shift(),n.isEmpty(c)&&delete this[a],c)},get:function(a,c){return n.isEmpty(a)||b.isEmptyObject(this[a])?[]:b.isFunction(c)?b.grep(this[a],c):this[a]},getNRemove:function(a,c){return n.isEmpty(a)||b.isEmptyObject(this[a])?[]:this.remove(a,c)},remove:function(a,c){var d=[];return n.isEmpty(a)||b.isEmptyObject(this[a])?d:b.isFunction(c)?(d=b.grep(this[a],c),this[a]=b.grep(this[a],c,!0),d):(b.extend(d,this[a]),delete this[a],d)}},b.extend(n,{isReady:e,ready:function(a){return n.isReady()?this:(b(g).ready(function(){n.loader.load(a)}),this)},is2DVector:function(a){return b.isEmptyObject(a)?!1:b.isNumeric(a.x)&&b.isNumeric(a.y)},isEmpty:function(a){return void 0===a||null===a},remove:function(a,c){return b.isEmptyObject(c)?a:(b.isArray(a)?i.call(a,c,1):b.isPlainObject(a)&&delete a[c],a)}}),a.console=a.console||{},a.console.log=console.log||function(){return arguments},a.console.debug=console.debug||function(){a.console.log.apply(a.console,arguments)},a.console.info=console.info||function(){a.console.log.apply(a.console,arguments)},a.console.warn=console.warn||function(){a.console.log.apply(a.console,arguments)},a.console.error=console.error||function(){a.console.log.apply(a.console,arguments)},b.extend(n,{debugLevel:0,infoLevel:1,warnLevel:2,errorLevel:3,logDebug:function(){return 0===arguments.length||this.logLevel>n.debugLevel?this:(l.call(arguments,f("DEBUG")),a.console.debug.apply(a.console,arguments),this)},logInfo:function(){return 0===arguments.length||this.logLevel>n.infoLevel?this:(l.call(arguments,f("INFO")),a.console.info.apply(a.console,arguments),this)},logWarn:function(){return 0===arguments.length||this.logLevel>n.warnLevel?this:(l.call(arguments,f("WARN")),a.console.warn.apply(a.console,arguments),this)},logError:function(){return 0===arguments.length||this.logLevel>n.errorLevel?this:(l.call(arguments,f("ERROR")),a.console.error.apply(a.console,arguments),this)},logLevel:n.errorLevel}),b.extend(n,{rotate:function(a,c,d){var e,f,g;return!b.isNumeric(c)||0===c||n.isEmpty(a.x)||n.isEmpty(a.y)?a:(d=d||{x:0,y:0},e={x:a.x-d.x,y:a.y-d.y},f=Math.cos(c),g=Math.sin(c),{x:d.x+e.x*f-e.y*g,y:d.y+e.x*g+e.y*f})},max:function(){var a=arguments[0],c={index:-1,value:+1/0};return b.isArrayLike(a)||(a=[],b.each(arguments,function(b,c){k.call(a,c)})),c.value=Math.max.apply(Math,a),c.index=j.call(a,c.value),c},min:function(){var a=arguments[0],c={index:-1,value:-1/0};return b.isArrayLike(a)||(a=[],b.each(arguments,function(b,c){k.call(a,c)})),c.value=Math.min.apply(Math,a),c.index=j.call(a,c.value),c},mod:function(a,b){return(a%b+b)%b},dot:function(a,b){return n.is2DVector(a)&&n.is2DVector(b)?a.x*b.x+a.y*b.y:1},rad:function(a,b){return n.is2DVector(a)&&n.is2DVector(b)?Math.atan2(a.x*b.y-b.x*a.y,n.dot(a,b)):0},norm:function(a){return Math.sqrt(n.dot(a,a))},round:function(a){return b.isNumeric(a)?~~(a+.5):a}}),a.WebSocket=a.WebSocket||{},a.WebSocket.OPEN=a.WebSocket.OPEN||1,b.extend(n,{lifetimeCandidate:2e3}),n.Device=function(a){return this instanceof n.Device?(this.id=Math.uuidFast(),void(this.webSocket=a)):new n.Device(a)},n.Device.prototype={send:function(c){if(b.isEmptyObject(c)||n.isEmpty(c.action))return n.logError("[imMatch.Device.send] The format of message is wrong! Message: ",c),this;if(this.webSocket.readyState!==a.WebSocket.OPEN)return n.logError("[imMatch.Device.send] WebSocket is not ready. ready state: "+this.webSocket.readyState),this;try{this.webSocket.send(m.call(this,c))}catch(d){n.error("[imMatch.Group.addGroup] WEbSocket failed to send message. Error Message: "+d.message)}return this}},n.Group=function(a){return this instanceof n.Group?(this.id=Math.uuidFast(),this.devices=[],this.numExchangedDoneDevices=0,this.numDevicesSynced={},void this.addDevices(a)):new n.Group(a)},n.Group.prototype={addDevices:function(a){return b.isEmptyObject(a)?this:(b.isArray(a)||(a=[a]),k.apply(this.devices,a),this)},synchronize:function(a){return b.isEmptyObject(a)?this:(this.broadcast(a),n.isEmpty(this.numDevicesSynced[a.chunk])&&(this.numDevicesSynced[a.chunk]=0),++this.numDevicesSynced[a.chunk],this.numDevicesSynced[a.chunk]!==this.devices.length?this:(delete this.numDevicesSynced[a.chunk],this.stitch()?this:(this.broadcast({action:"synchronizeDone",chunk:a.chunk}),this)))},broadcast:function(a){return b.isEmptyObject(a)?this:(b.each(this.devices,function(b,c){c.send(a)}),this)},getStitchingInfo:function(){var a=this,c=n.webSocketServer.caches.get("stitchingInfo"),d;return b.each(c,function(b,c){return a.id===c[0].groupID||a.id===c[1].groupID?(d=c,!1):void 0}),d},stitch:function(){var a=this.getStitchingInfo();return b.isEmptyObject(a)?!1:(this.id===a[1].groupID&&(a=a.reverse()),this.broadcast({action:"stitching",stitchingInfo:a}),n.logInfo("[imMatch.Group.stitch][device1]",a[0],"[device2]",a[1]),!0)}},b.extend(c.Server.prototype,{groups:{},caches:new n.Cache,addGroup:function(a){var c,d;return b.isEmptyObject(a)?(n.logWarn("[ws.Server.addGroup] NO webSocket."),this):(d=new n.Device(a),c=new n.Group(d),this.groups[c.id]=c,d.send({action:"connectionSuccess",groupID:c.id,deviceID:d.id,numDevices:c.devices.length}),c)},monitorCaches:function(){var a=Date.now();return this.caches.remove("stitchingCandidate",function(b){return Math.abs(a-b.timeStamp)>n.lifetimeCandidate}),setTimeout(this.monitorCaches.bind(this),n.lifetimeCandidate),this},addCandidate:function(a){return b.isEmptyObject(a)?this:(this.caches.remove("stitchingCandidate",function(b){return a.groupID===b.groupID&&a.deviceID===b.deviceID}),this.caches.queue("stitchingCandidate",a),this)},searchMatchCandidate:function(a){var c=this.caches.get("stitchingCandidate"),d;return b.isEmptyObject(a)?null:(b.each(c.reverse(),function(b,c){return a.deviceID!==c.deviceID&&Math.abs(a.timeStamp-c.timeStamp)<n.lifetimeCandidate?(d=c,!1):void 0}),d)},computeAffineFactor:function(a){a.rad=n.rad(a.orientation,{x:1,y:0});var b=n.AffineTransform.getRotateInstance(a.rad);return a.margin=b.transform(a.margin),a.point=b.transform(a.point),a.translationFactor={x:a.margin.x-a.point.x,y:a.margin.y-a.point.y},delete a.margin,delete a.point,delete a.orientation,this},response:{connection:function(a){return this.addGroup(a),this},close:function(a,b){return n.logInfo("[ws.Server.response.close] The client closes WebSocket. deviceID = "+b.deviceID+", groupID = "+b.groupID+". Message: "+a.message),this},error:function(a,c){b.error("[ws.Server.response.error] WebSocket error. Device: "+c.deviceID+", in group: "+c.groupID+". Error message: "+a.message)},tryToStitch:function(a){var c=this.searchMatchCandidate(a),d,e,f,g;return b.isEmptyObject(c)?(this.addCandidate(a),this):(d=this.groups[a.groupID],e=this.groups[c.groupID],n.isEmpty(d)||n.isEmpty(e)?(n.logError("[ws.Server.tryToStitch] group or matchGroup are empty. group:",d,"matchGroup:",e),this):b.isEmptyObject(d.getStitchingInfo())&&b.isEmptyObject(e.getStitchingInfo())?d.id===e.id?this:(d.numDevicesSynced={},e.numDevicesSynced={},f=d.devices.length,g=e.devices.length,a.orientation.x=-a.orientation.x,a.orientation.y=-a.orientation.y,this.computeAffineFactor(a),this.computeAffineFactor(c),a.numExchangedDevices=g,c.numExchangedDevices=f,this.caches.queue("stitchingInfo",[a,c]),d.stitch(),void e.stitch()):(n.logDebug("[ws.Server.tryToStitch] Groups are stitching. group:",d,"matchGroup:",e),this))},synchronize:function(a){return this.groups[a.groupID].synchronize(a),this},exchange:function(a){var c=this.groups[a.toGroupID];return b.isEmptyObject(c)?this:void c.broadcast(a)},exchangeDone:function(a){var b=this.groups[a.groupID],c=this.groups[a.toGroupID],d=b.devices.length+c.devices.length;return++b.numExchangedDoneDevices,++c.numExchangedDoneDevices,d!==b.numExchangedDoneDevices||d!==c.numExchangedDoneDevices?this:(b.numExchangedDoneDevices=0,this.caches.remove("stitchingInfo"),b.addDevices(c.devices),delete this.groups[a.toGroupID],void b.broadcast({action:"exchangeDone",groupID:b.id,numDevices:b.devices.length}))}}}),n.logLevel=n.infoLevel,n.isReady=d,n.webSocketServer=new c.Server({port:8080,host:null}),n.webSocketServer.on("connection",function(a){var c=this;this.response.connection.call(this,a),a.on("message",function(a){var d,e;return b.isEmptyObject(a)?void n.logError("[WebSocket.onmessage] The message is empty!"):(d=b.parseJSON(a),d.timeStamp=Date.now(),n.logDebug("[WebSocket.onmessage] Action Type: "+d.action,d),e=c.response[d.action],n.isEmpty(e)?void n.logWarn("[WebSocket.onmessage] Unknown action: "+d.action):void e.call(c,d))}),a.on("close",function(b){c.response.close.call(c,b,a)}),a.on("error",function(b){c.response.error.call(c,b,a)})}),n.webSocketServer.on("error",function(a){b.error("[imMatch.webSocketServer] WebSocket Server error. error message: "+a.message)}),n.webSocketServer.monitorCaches(),n});